<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Eventica</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="404.css">
    <script src="https://kit.fontawesome.com/64d58efce2.js" crossorigin="anonymous"></script>
    <style>
        /* --- Dashboard Styles --- */
        .dashboard-container { max-width: 1200px; margin: 100px auto 50px; padding: 20px; }
        .dashboard-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dashboard-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
        .dashboard-card:hover { transform: translateY(-5px); }
        .dashboard-card h3 { color: var(--primary-color); margin-bottom: 15px; }
        .profile-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .btn-primary { background: var(--primary-color); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; margin: 5px; }
        .btn-primary:hover { background: var(--secondary-color); }
        .btn-danger { background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-danger:hover { background: #c82333; }
        .loading { text-align: center; padding: 50px; }
        .error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px; }

        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 99999; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 400px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .modal input, .modal textarea { width: 100%; padding: 8px; margin: 5px 0 10px; border: 1px solid #ccc; border-radius: 5px; }
        .modal h2 { color: var(--primary-color); margin-bottom: 15px; }

        /* --- Event Cards --- */
        #upcoming-events, #past-events { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .event-card { background: #fff; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.2s; }
        .event-card:hover { transform: translateY(-3px); }
        .event-card img { width: 100%; height: 150px; object-fit: cover; }
        .event-card-content { padding: 15px; }
        .event-card-content h4 { margin: 0; color: var(--primary-color); }
        .event-card-content p { margin: 5px 0; font-size: 0.9rem; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="logo-container">
                <img src="assets/images/logo.png" alt="Eventica" class="logo">
                <span class="logo-text">Eventica</span>
            </div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="./assets/pastevents/pastevents.html">Events</a></li>
                <li><a href="/dashboard.html">Dashboard</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <div id="loading" class="loading"><h2>Loading your dashboard...</h2></div>

        <div id="dashboard-content" style="display:none;">
            <div class="dashboard-header">
                <h1>Welcome to Your Dashboard</h1>
                <p id="user-welcome">Hello, <span id="username"></span>!</p>
            </div>

            <button class="btn-primary" onclick="connectGoogleCalendar()">Connect Google Calendar</button>
            <div id="google-events"></div>

            <div class="dashboard-grid">
                <!-- Profile Section -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-user"></i> Your Profile</h3>
                    <div class="profile-section">
                        <p><strong>Username:</strong> <span id="profile-username"></span></p>
                        <p><strong>Email:</strong> <span id="profile-email"></span></p>
                        <p><strong>Member since:</strong> <span id="member-since"></span></p>
                    </div>
                    <button class="btn-primary" onclick="openEditProfileModal()">Edit Profile</button>
                </div>

                <!-- Events Section -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-calendar"></i> Your Events</h3>
                    <p>Manage your created events.</p>
                    <button class="btn-primary" onclick="openCreateEventModal()">Create Event</button>
                    
                    <h4>Upcoming Events</h4>
                    <div id="upcoming-events"></div>

                    <h4>Past Events</h4>
                    <div id="past-events"></div>
                </div>

                <!-- Quick Actions -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                    <button class="btn-primary" onclick="changePassword()">Change Password</button>
                    <button class="btn-danger" onclick="deleteAccount()">Delete Account</button>
                </div>
            </div>
        </div>

        <div id="error-content" style="display:none;">
            <div class="error-message">
                <h3>Authentication Required</h3>
                <p>Please log in to access your dashboard.</p>
                <a href="./assets/register/register.html" class="btn-primary">Login</a>
            </div>
        </div>
    </div>

    <!-- Event Creation Modal -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <h2>Create New Event</h2>
            <label>Title:</label><input type="text" id="event-title" required>
            <label>Date:</label><input type="date" id="event-date" required>
            <label>Time:</label><input type="text" id="event-time">
            <label>Location:</label><input type="text" id="event-location">
            <label>Description:</label><textarea id="event-description"></textarea>
            <label>Image URL:</label><input type="text" id="event-image">
            <label>Website:</label><input type="text" id="event-website">
            <button class="btn-primary" onclick="submitEvent()">Save Event</button>
            <button class="btn-danger" onclick="closeEventModal()">Cancel</button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <h2>Edit Profile</h2>
            <label>Username:</label><input type="text" id="edit-username">
            <label>Email:</label><input type="email" id="edit-email">
            <label>New Password (optional):</label><input type="password" id="edit-password">
            <button class="btn-primary" onclick="saveProfileChanges()">Save Changes</button>
            <button class="btn-danger" onclick="closeEditProfileModal()">Cancel</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('eventica_token');
            const user = localStorage.getItem('eventica_user');
            if (!token || !user) return showError();
            try {
                const userData = JSON.parse(user);
                await loadDashboard(userData, token);
                await loadEvents();
            } catch (err) { console.error(err); showError(); }

            window.addEventListener('click', e => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; });
        });

        async function loadDashboard(userData, token) {
            try {
                const res = await fetch(`${API_BASE_URL}/profile/getprofile`, { headers: { 'Authorization': `Bearer ${token}` }});
                const data = await res.json();
                displayDashboard(data.user);
            } catch { showError(); }
        }

        function displayDashboard(user) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('username').textContent = user.username;
            document.getElementById('profile-username').textContent = user.username;
            document.getElementById('profile-email').textContent = user.email;
            document.getElementById('member-since').textContent = new Date(user.createdAt).toLocaleDateString();
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-content').style.display = 'block';
        }

        // --- Event Modals ---
        function openCreateEventModal() { document.getElementById('event-modal').style.display = 'flex'; }
        function closeEventModal() { document.getElementById('event-modal').style.display = 'none'; }

        // ✅ FIXED SUBMIT EVENT FUNCTION
        async function submitEvent() {
            const newEvent = {
                title: document.getElementById('event-title').value.trim(),
                description: document.getElementById('event-description').value.trim(),
                eventDate: document.getElementById('event-date').value,
                time: document.getElementById('event-time').value.trim(),
                location: document.getElementById('event-location').value.trim(),
                image: document.getElementById('event-image').value.trim(),
                website: document.getElementById('event-website').value.trim()
            };

            if (!newEvent.title || !newEvent.description || !newEvent.eventDate || !newEvent.time || !newEvent.location) {
                return alert('All fields are required.');
            }

            const token = localStorage.getItem('eventica_token');
            try {
                const res = await fetch(`${API_BASE_URL}/events`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(newEvent)
                });
                const data = await res.json();
                if (res.ok) {
                    alert('✅ Event created successfully!');
                    closeEventModal();
                    await loadEvents();
                } else {
                    console.error('❌ Event creation failed:', data);
                    alert(`Failed to create event: ${data.message || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('❌ Network or server error:', err);
                alert('Error creating event.');
            }
        }

        // ✅ FIXED LOAD EVENTS FUNCTION
        async function loadEvents() {
            try {
                const res = await fetch(`${API_BASE_URL}/events`);
                const events = await res.json();
                const upcomingContainer = document.getElementById('upcoming-events');
                const pastContainer = document.getElementById('past-events');
                upcomingContainer.innerHTML = '';
                pastContainer.innerHTML = '';

                const now = new Date();

                events.forEach(ev => {
                    const eventDate = new Date(ev.eventDate);
                    const html = `
                        <div class="event-card">
                            <img src="${ev.image || 'https://via.placeholder.com/400x150'}" alt="${ev.title}">
                            <div class="event-card-content">
                                <h4>${ev.title}</h4>
                                <p><strong>${eventDate.toLocaleDateString()}</strong> • ${ev.time || ''}</p>
                                <p>${ev.location || ''}</p>
                                <p>${ev.description || ''}</p>
                                <a href="${ev.website || '#'}" target="_blank" class="btn-primary" style="padding:5px 10px; font-size:0.8rem;">View</a>
                            </div>
                        </div>`;
                    if (eventDate >= now) upcomingContainer.innerHTML += html;
                    else pastContainer.innerHTML += html;
                });
            } catch (err) { console.error('Error loading events:', err); }
        }

        // --- Profile Edit ---
        function openEditProfileModal() {
            document.getElementById('edit-username').value = document.getElementById('profile-username').textContent;
            document.getElementById('edit-email').value = document.getElementById('profile-email').textContent;
            document.getElementById('edit-password').value = '';
            document.getElementById('edit-profile-modal').style.display = 'flex';
        }
        function closeEditProfileModal() { document.getElementById('edit-profile-modal').style.display = 'none'; }

        async function saveProfileChanges() {
            const token = localStorage.getItem('eventica_token');
            const updated = {
                username: document.getElementById('edit-username').value.trim(),
                email: document.getElementById('edit-email').value.trim(),
                password: document.getElementById('edit-password').value.trim()
            };
            if (!updated.username || !updated.email) return alert('Username and email are required.');
            try {
                const res = await fetch(`${API_BASE_URL}/profile/editprofile`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(updated)
                });
                if (res.ok) {
                    alert('Profile updated successfully!');
                    closeEditProfileModal();
                    document.getElementById('profile-username').textContent = updated.username;
                    document.getElementById('profile-email').textContent = updated.email;
                    document.getElementById('username').textContent = updated.username;
                } else alert('Failed to update profile');
            } catch { alert('Error updating profile'); }
        }

        // --- Misc ---
        function changePassword() { openEditProfileModal(); }
        function logout() { localStorage.clear(); window.location.href = '/'; }
        async function deleteAccount() {
            if (!confirm('Are you sure you want to delete your account?')) return;
            const token = localStorage.getItem('eventica_token');
            try {
                const res = await fetch(`${API_BASE_URL}/profile/deleteProfile`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) { alert('Account deleted'); localStorage.clear(); window.location.href = '/'; }
                else alert('Failed to delete account');
            } catch { alert('Error deleting account'); }
        }

        function connectGoogleCalendar() { window.location.href = "http://localhost:3000/auth/google"; }
    </script>
</body>
</html>
